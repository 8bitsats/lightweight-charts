<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price-Position Markers Example</title>
    <!-- Import a specific version of the library from CDN -->
    <script type="text/javascript" src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        h1, h2 {
            color: #333;
            text-align: center;
        }
        
        #chart-container {
            width: 800px;
            height: 400px;
            margin: 20px auto;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .controls {
            width: 800px;
            margin: 20px auto;
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .info-panel {
            width: 800px;
            margin: 20px auto;
            padding: 15px;
            background-color: #e8f4fd;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        button {
            background-color: #2962FF;
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            margin: 5px;
            border-radius: 3px;
        }

        button:hover {
            background-color: #1E4EC7;
        }

        pre {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }

        #log {
            margin-top: 10px;
            font-family: monospace;
            height: 100px;
            overflow-y: auto;
            background-color: #f8f8f8;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <h1>Price-Position Markers Example</h1>
    <div class="info-panel">
        <h2>Fixing Marker Positioning Issues</h2>
        <p>This example demonstrates how to properly position markers at specific price levels using both invisible line series and visible candlestick series. The key is using the <code>price</code> property in the marker configuration.</p>
    </div>
    
    <div id="chart-container"></div>
    
    <div class="controls">
        <h3>Marker Control</h3>
        <button id="add-markers">Add Markers to Line Series</button>
        <button id="add-markers-candle">Add Markers to Candle Series</button>
        <button id="toggle-line">Toggle Line Visibility</button>
        <button id="clear-markers">Clear All Markers</button>
        <div id="log"></div>
    </div>

    <div class="info-panel">
        <h3>Key Implementation Details</h3>
        <p>When using markers with the <code>price</code> property:</p>
        <ol>
            <li>Use marker positions like <code>atPriceTop</code>, <code>atPriceMiddle</code>, or <code>atPriceBottom</code> for precise price-based positioning</li>
            <li>Always include the <code>price</code> property in your marker configuration</li>
            <li>The markers will be positioned at the exact price level regardless of the series data</li>
        </ol>
        
        <h3>Example Marker Configuration:</h3>
        <pre>
{
  time: '2019-01-18',
  position: 'atPriceTop',
  shape: 'arrowDown',
  color: 'orange',
  price: 178  // This is the key property for precise positioning
}
        </pre>
    </div>

    <script>
        // Log function
        function log(message) {
            const logElement = document.getElementById('log');
            logElement.innerHTML += `> ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        try {
            log("Starting chart creation...");
            
            // Use the global LightweightCharts object from the CDN
            const { createChart } = LightweightCharts;
            
            // Create chart
            const chart = createChart(document.getElementById('chart-container'), {
                width: 800,
                height: 400,
                layout: {
                    backgroundColor: '#000000',
                    textColor: 'rgba(255, 255, 255, 0.9)',
                },
                grid: {
                    vertLines: {
                        color: 'rgba(197, 203, 206, 0.5)',
                    },
                    horzLines: {
                        color: 'rgba(197, 203, 206, 0.5)',
                    },
                },
                crosshair: {
                    mode: 1, // CrosshairMode.Normal
                },
                rightPriceScale: {
                    borderColor: 'rgba(197, 203, 206, 0.8)',
                },
                timeScale: {
                    borderColor: 'rgba(197, 203, 206, 0.8)',
                },
            });

            // Add line series (initially invisible)
            const lineSeries = chart.addLineSeries({
                color: 'rgba(255, 255, 255, 0)', // transparent line
                lastValueVisible: false,
                priceLineVisible: false
            });

            // Set line data
            const lineData = [
                { time: '2018-12-26', value: 162 },
                { time: '2019-01-18', value: 178 },
                { time: '2019-02-25', value: 191 },
                { time: '2019-03-21', value: 187.50 },
                { time: '2019-04-03', value: 196.80 },
                { time: '2019-05-07', value: 195.90 },
                { time: '2019-05-21', value: 188 },
            ];
            lineSeries.setData(lineData);

            // Add candlestick series
            const candleSeries = chart.addCandlestickSeries({
                lastValueVisible: false,
                priceLineVisible: false
            });

            // Set candlestick data
            const candleData = [
                { time: '2018-12-26', open: 159.46, high: 168.28, low: 159.44, close: 168.28 },
                { time: '2018-12-27', open: 166.44, high: 170.46, low: 163.36, close: 170.32 },
                { time: '2018-12-28', open: 171.22, high: 173.12, low: 168.60, close: 170.22 },
                { time: '2018-12-31', open: 171.47, high: 173.24, low: 170.65, close: 171.82 },
                { time: '2019-01-02', open: 169.71, high: 173.18, low: 169.05, close: 172.41 },
                { time: '2019-01-03', open: 171.84, high: 171.84, low: 168.21, close: 168.61 },
                { time: '2019-01-04', open: 170.18, high: 174.74, low: 169.52, close: 173.62 },
                { time: '2019-01-07', open: 173.83, high: 178.18, low: 173.83, close: 177.04 },
                { time: '2019-01-08', open: 178.57, high: 179.59, low: 175.61, close: 177.89 },
                { time: '2019-01-09', open: 177.87, high: 181.27, low: 177.10, close: 179.73 },
                { time: '2019-01-10', open: 178.03, high: 179.24, low: 176.34, close: 179.06 },
                { time: '2019-01-11', open: 177.93, high: 180.26, low: 177.12, close: 179.41 },
                { time: '2019-01-14', open: 177.59, high: 179.23, low: 176.90, close: 178.81 },
                { time: '2019-01-15', open: 176.08, high: 177.82, low: 175.20, close: 176.47 },
                { time: '2019-01-16', open: 177.09, high: 177.93, low: 175.86, close: 177.04 },
                { time: '2019-01-17', open: 174.01, high: 175.46, low: 172.00, close: 174.87 },
                { time: '2019-01-18', open: 176.98, high: 180.04, low: 176.18, close: 179.58 },
                { time: '2019-01-22', open: 177.49, high: 178.60, low: 175.36, close: 177.11 },
                // ... more data ...
                { time: '2019-02-25', open: 192.75, high: 193.42, low: 189.96, close: 189.98 },
                { time: '2019-03-21', open: 185.50, high: 190.00, low: 185.50, close: 189.97 },
                { time: '2019-04-03', open: 194.98, high: 198.78, low: 194.11, close: 198.61 },
                { time: '2019-05-07', open: 196.75, high: 197.65, low: 192.96, close: 194.77 },
                { time: '2019-05-21', open: 187.13, high: 192.52, low: 186.34, close: 191.45 },
            ];
            candleSeries.setData(candleData);

            // Define markers with precise price property
            const lineMarkers = [
                { time: '2018-12-26', position: 'aboveBar', shape: 'circle', color: 'orange', price: 162 },
                { time: '2019-01-18', position: 'aboveBar', shape: 'arrowDown', color: 'orange', price: 178 },
                { time: '2019-02-25', position: 'aboveBar', shape: 'arrowDown', color: 'orange', price: 191 },
                { time: '2019-03-21', position: 'belowBar', shape: 'arrowUp', color: 'orange', price: 187.50 },
                { time: '2019-04-03', position: 'aboveBar', shape: 'arrowDown', color: 'orange', price: 196.80 },
                { time: '2019-05-07', position: 'belowBar', shape: 'arrowUp', color: 'orange', price: 195.90 },
                { time: '2019-05-21', position: 'inBar', shape: 'circle', color: 'orange', price: 188 }
            ];

            // Define markers for candlestick series
            const candleMarkers = [
                { time: '2018-12-26', position: 'inBar', shape: 'circle', color: 'rgba(0, 255, 0, 1)', price: 162, text: 'Buy' },
                { time: '2019-01-18', position: 'aboveBar', shape: 'arrowDown', color: 'rgba(255, 0, 0, 1)', price: 178, text: 'Sell' },
                { time: '2019-02-25', position: 'aboveBar', shape: 'arrowDown', color: 'rgba(255, 0, 0, 1)', price: 191, text: 'Sell' },
                { time: '2019-03-21', position: 'belowBar', shape: 'arrowUp', color: 'rgba(0, 255, 0, 1)', price: 187.50, text: 'Buy' },
                { time: '2019-04-03', position: 'aboveBar', shape: 'arrowDown', color: 'rgba(255, 0, 0, 1)', price: 196.80, text: 'Sell' },
                { time: '2019-05-07', position: 'belowBar', shape: 'arrowUp', color: 'rgba(0, 255, 0, 1)', price: 195.90, text: 'Buy' },
                { time: '2019-05-21', position: 'inBar', shape: 'circle', color: 'rgba(0, 0, 255, 1)', price: 188, text: 'Hold' }
            ];

            // Add event listeners
            document.getElementById('add-markers').addEventListener('click', () => {
                try {
                    lineSeries.setMarkers(lineMarkers);
                    log("Added markers to line series with correct price positions");
                } catch (e) {
                    log("Error: " + e.message);
                }
            });

            document.getElementById('add-markers-candle').addEventListener('click', () => {
                try {
                    candleSeries.setMarkers(candleMarkers);
                    log("Added markers to candle series with correct price positions");
                } catch (e) {
                    log("Error: " + e.message);
                }
            });

            document.getElementById('toggle-line').addEventListener('click', () => {
                try {
                    const currentOptions = lineSeries.options();
                    const isVisible = currentOptions.color !== 'rgba(255, 255, 255, 0)';
                    
                    if (isVisible) {
                        lineSeries.applyOptions({
                            color: 'rgba(255, 255, 255, 0)' // make invisible
                        });
                        log("Line series is now invisible");
                    } else {
                        lineSeries.applyOptions({
                            color: 'rgba(76, 175, 80, 1)' // make visible with green color
                        });
                        log("Line series is now visible");
                    }
                } catch (e) {
                    log("Error toggling visibility: " + e.message);
                }
            });

            document.getElementById('clear-markers').addEventListener('click', () => {
                try {
                    lineSeries.setMarkers([]);
                    candleSeries.setMarkers([]);
                    log("Cleared all markers");
                } catch (e) {
                    log("Error clearing markers: " + e.message);
                }
            });

            // Fit content to view all data
            chart.timeScale().fitContent();
            
            // Initial log message
            log("Chart created. Use the buttons to add markers and test positioning.");
        } catch (err) {
            log(`Error in script: ${err.message}`);
            console.error("Script error:", err);
        }
    </script>
</body>
</html> 