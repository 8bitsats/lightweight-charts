<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price-Based Markers Example</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        
        #chart-container {
            width: 800px;
            height: 400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .controls {
            width: 800px;
            margin: 20px auto;
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .control-group {
            margin-bottom: 10px;
        }

        label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }

        input, select, button {
            padding: 5px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }

        button {
            background-color: #2962FF;
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            margin-top: 10px;
        }

        button:hover {
            background-color: #1E4EC7;
        }
    </style>
</head>
<body>
    <h1>Price-Based Markers Example</h1>
    <div id="chart-container"></div>
    
    <div class="controls">
        <h3>Add Price Marker</h3>
        <div class="control-group">
            <label for="marker-time">Time:</label>
            <select id="marker-time"></select>
        </div>
        <div class="control-group">
            <label for="marker-price">Price:</label>
            <input type="number" id="marker-price" step="0.01">
        </div>
        <div class="control-group">
            <label for="marker-color">Color:</label>
            <input type="color" id="marker-color" value="#FF5733">
        </div>
        <div class="control-group">
            <label for="marker-shape">Shape:</label>
            <select id="marker-shape">
                <option value="circle">Circle</option>
                <option value="square">Square</option>
                <option value="arrowUp">Arrow Up</option>
                <option value="arrowDown">Arrow Down</option>
            </select>
        </div>
        <div class="control-group">
            <label for="marker-text">Text:</label>
            <input type="text" id="marker-text" placeholder="Marker text">
        </div>
        <button id="add-marker">Add Marker</button>
        <button id="clear-markers">Clear All Markers</button>
    </div>

    <script type="module">
        // Import the createChart function from the local build
        import { createChart } from './dist/lightweight-charts.standalone.development.mjs';

        // Create the chart
        const chart = createChart(document.getElementById('chart-container'), {
            width: 800,
            height: 400,
            layout: {
                background: { color: '#ffffff' },
                textColor: '#333',
            },
            grid: {
                vertLines: { color: '#f0f0f0' },
                horzLines: { color: '#f0f0f0' },
            },
            crosshair: {
                mode: 0, // CrosshairMode.Normal
            },
            rightPriceScale: {
                borderColor: '#dfdfdf',
            },
            timeScale: {
                borderColor: '#dfdfdf',
                timeVisible: true,
            },
        });

        // Create a candlestick series
        const candlestickSeries = chart.addCandlestickSeries({
            upColor: '#26a69a',
            downColor: '#ef5350',
            borderVisible: false,
            wickUpColor: '#26a69a',
            wickDownColor: '#ef5350',
        });

        // Sample data
        const candlestickData = [
            { time: '2023-01-01', open: 100, high: 105, low: 95, close: 102 },
            { time: '2023-01-02', open: 102, high: 107, low: 101, close: 105 },
            { time: '2023-01-03', open: 105, high: 110, low: 104, close: 108 },
            { time: '2023-01-04', open: 108, high: 112, low: 107, close: 110 },
            { time: '2023-01-05', open: 110, high: 115, low: 109, close: 114 },
            { time: '2023-01-06', open: 114, high: 118, low: 112, close: 116 },
            { time: '2023-01-07', open: 116, high: 120, low: 115, close: 118 },
            { time: '2023-01-08', open: 118, high: 121, low: 116, close: 120 },
            { time: '2023-01-09', open: 120, high: 123, low: 118, close: 122 },
            { time: '2023-01-10', open: 122, high: 125, low: 120, close: 124 },
            { time: '2023-01-11', open: 124, high: 127, low: 123, close: 126 },
            { time: '2023-01-12', open: 126, high: 130, low: 125, close: 128 },
            { time: '2023-01-13', open: 128, high: 132, low: 127, close: 130 },
            { time: '2023-01-14', open: 130, high: 135, low: 129, close: 133 },
            { time: '2023-01-15', open: 133, high: 138, low: 132, close: 136 },
        ];

        // Set the data
        candlestickSeries.setData(candlestickData);

        // Fit the chart to the data
        chart.timeScale().fitContent();

        // Populate the time dropdown
        const timeSelect = document.getElementById('marker-time');
        candlestickData.forEach(dataPoint => {
            const option = document.createElement('option');
            option.value = dataPoint.time;
            option.text = dataPoint.time;
            timeSelect.appendChild(option);
        });

        // Set default price value
        document.getElementById('marker-price').value = candlestickData[candlestickData.length - 1].close;

        // Current markers array
        let currentMarkers = [];

        // Function to add a marker at a specific price level
        function addPriceMarker() {
            const time = document.getElementById('marker-time').value;
            const price = parseFloat(document.getElementById('marker-price').value);
            const color = document.getElementById('marker-color').value;
            const shape = document.getElementById('marker-shape').value;
            const text = document.getElementById('marker-text').value;

            // Create a new marker
            const newMarker = {
                time: time,
                position: 'inBar', // This is a placeholder, we'll override it with custom positioning
                color: color,
                shape: shape,
                text: text,
                // Add a custom property for price
                price: price
            };

            // Add the new marker to our array
            currentMarkers.push(newMarker);
            
            // Update the markers on the chart
            updateMarkers();
        }

        // Function to update markers on the chart
        function updateMarkers() {
            // Set the markers on the series
            candlestickSeries.setMarkers(currentMarkers);

            // For each marker, we need to manually position it at the correct price level
            currentMarkers.forEach(marker => {
                // Find the DOM element for this marker
                // This is a bit of a hack since the library doesn't officially support this
                setTimeout(() => {
                    const markerElements = document.querySelectorAll('.tv-lightweight-charts-mark');
                    markerElements.forEach(element => {
                        // Check if this element corresponds to our marker
                        // We can use the time and text to identify it
                        const markerText = element.querySelector('.tv-lightweight-charts-mark-text');
                        if (markerText && markerText.textContent === marker.text) {
                            // Get the y-coordinate for the price
                            const y = candlestickSeries.priceToCoordinate(marker.price);
                            if (y !== null) {
                                // Position the marker at the correct price level
                                element.style.transform = `translate(-50%, 0)`;
                                element.style.top = `${y}px`;
                            }
                        }
                    });
                }, 50); // Small delay to ensure the DOM has been updated
            });
        }

        // Function to clear all markers
        function clearMarkers() {
            currentMarkers = [];
            candlestickSeries.setMarkers([]);
        }

        // Add event listeners
        document.getElementById('add-marker').addEventListener('click', addPriceMarker);
        document.getElementById('clear-markers').addEventListener('click', clearMarkers);

        // Add a tooltip to show price and time
        chart.subscribeCrosshairMove((param) => {
            if (!param.time || param.point.x < 0 || param.point.y < 0) {
                return;
            }

            const data = param.seriesData.get(candlestickSeries);
            if (data) {
                console.log(`Time: ${param.time}, Price: ${param.point.y}`);
                // Update the price input with the current crosshair price
                document.getElementById('marker-price').value = param.point.y.toFixed(2);
            }
        });

        // Add some initial markers for demonstration
        document.getElementById('marker-time').value = candlestickData[5].time;
        document.getElementById('marker-price').value = 115;
        document.getElementById('marker-text').value = "Resistance";
        document.getElementById('marker-color').value = "#FF5733";
        document.getElementById('marker-shape').value = "arrowDown";
        addPriceMarker();

        document.getElementById('marker-time').value = candlestickData[10].time;
        document.getElementById('marker-price').value = 125;
        document.getElementById('marker-text').value = "Target";
        document.getElementById('marker-color').value = "#33FF57";
        document.getElementById('marker-shape').value = "square";
        addPriceMarker();
    </script>
</body>
</html> 